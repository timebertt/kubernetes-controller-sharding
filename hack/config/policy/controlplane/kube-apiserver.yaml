apiVersion: kyverno.io/v1
kind: Policy
metadata:
  name: kube-apiserver
  namespace: shoot--ixywdlfvei--sharding
spec:
  failurePolicy: Fail
  rules:
  # set static replicas on kube-apiserver to ensure similar evaluation environment between load test runs
  - name: disable-hpa
    match:
      any:
      - resources:
          kinds:
          - HorizontalPodAutoscaler
          names:
          - kube-apiserver
    mutate:
      patchStrategicMerge:
        spec:
          minReplicas: 4
          maxReplicas: 4
  # set static requests/limits on kube-apiserver to ensure similar evaluation environment between load test runs
  - name: resources
    match:
      any:
      - resources:
          kinds:
          - Pod
          selector:
            matchLabels:
              app: kubernetes
              role: apiserver
    mutate:
      patchStrategicMerge:
        spec:
          containers:
          - name: kube-apiserver
            resources:
              requests:
                cpu: 12000m
                memory: 12Gi
              limits:
                cpu: 12000m
                memory: 12Gi
            # set GOMAXPROCS to CPU quota to minimize goroutine scheduling contention (CPU throttling)
            env:
            - name: GOMAXPROCS
              value: "12"
  - name: disable-vpa
    match:
      any:
      - resources:
          kinds:
          - VerticalPodAutoscaler
          names:
          - kube-apiserver-vpa
    mutate:
      patchStrategicMerge:
        spec:
          updatePolicy:
            updateMode: Off
